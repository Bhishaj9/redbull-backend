<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recharge</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ========= Base & header (kept minimal, original structure preserved) ========= */
    :root {
      --bg-ui: #0b274d;
      /* dark blue theme */
      --accent: #0e4aa8;
      --muted: #f4f6fb;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(2, 8, 23, 0.35);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    body {
      background: linear-gradient(180deg, #f2f6fb 0%, #eef3fb 100%);
      color: #0b274d;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .container {
      max-width: 980px;
      margin: 18px auto;
      padding: 10px;
      width: 94%;
    }

    /* ======== UPDATED: make header a full blue navbar (replaces single-line back) ======== */
    header.app-header {
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      z-index: 60;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: linear-gradient(90deg, var(--accent), var(--bg-ui));
      color: #fff;
      box-shadow: 0 6px 18px rgba(3, 18, 60, 0.12);
      font-weight: 700;
      box-sizing: border-box;
      min-height: 56px;
    }

    header.app-header .back-btn {
      background: transparent;
      border: 0;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    header.app-header .title {
      flex: 1;
      text-align: left;
      font-size: 18px;
      color: #fff;
    }

    /* ========= Amount / cards UI (kept original layout but restyled) ========= */
    .amount-box {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-start;
      background: transparent;
      padding: 6px 0;
      margin-bottom: 18px;
    }

    .amt-btn {
      padding: 12px 22px;
      border-radius: 40px;
      border: 1px solid rgba(11, 39, 77, 0.08);
      background: #fff;
      font-size: 15px;
      font-weight: 700;
      color: var(--bg-ui);
      box-shadow: 0 2px 6px rgba(2, 8, 23, 0.04);
      cursor: pointer;
      transition: transform .12s, box-shadow .12s;
    }

    .amt-btn:hover {
      transform: translateY(-2px);
    }

    .amt-btn.active {
      background: linear-gradient(180deg, var(--accent), var(--bg-ui));
      color: #fff;
      box-shadow: 0 12px 30px rgba(11, 39, 77, 0.28);
    }

    .rech-card {
      background: var(--card);
      padding: 18px;
      border-radius: 14px;
      margin-bottom: 16px;
      box-shadow: 0 6px 18px rgba(2, 8, 23, 0.04);
    }

    .balance-label {
      color: #556;
      margin-bottom: 10px;
    }

    .balance-label span {
      color: var(--bg-ui);
      font-weight: 800;
    }

    .input-box {
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 10px;
      border: 1px solid #e6e9f2;
      padding: 8px 10px;
    }

    .input-box .rs {
      font-weight: 700;
      color: var(--bg-ui);
    }

    input[type="number"]#amountInput {
      border: 0;
      outline: 0;
      font-size: 16px;
      padding: 10px 6px;
      width: 100%;
    }

    .pay-btn {
      width: 100%;
      margin-top: 10px;
      background: linear-gradient(180deg, var(--bg-ui), var(--accent));
      color: #fff;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-size: 16px;
    }

    .info-box {
      font-size: 13px;
      color: #445;
      margin-top: 14px;
      line-height: 1.4;
    }

    /* payment method labels - now styled as icon tiles */
    .pay-methods {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pay-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 112px;
      height: 88px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #eef2ff;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.03);
      padding: 10px;
      transition: transform .12s, box-shadow .12s, border-color .12s;
    }

    .pay-option:focus {
      outline: 3px solid rgba(14, 74, 168, 0.12);
      outline-offset: 2px;
    }

    .pay-option .pay-icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #fff;
      background: linear-gradient(180deg, #0e4aa8, #0b274d);
      box-shadow: 0 6px 14px rgba(11, 39, 77, 0.18);
    }

    .pay-option .pay-label {
      font-size: 13px;
      font-weight: 800;
      color: #0b274d;
    }

    .pay-option.active {
      border-color: rgba(14, 74, 168, 0.22);
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(11, 39, 77, 0.18);
    }

    /* tabs */
    .tabs-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .tab-switch {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      color: var(--bg-ui);
      font-weight: 700;
    }

    .tab-switch.active {
      background: linear-gradient(90deg, var(--accent), var(--bg-ui));
      color: #fff;
      box-shadow: 0 10px 25px rgba(11, 39, 77, 0.12);
    }

    /* ========= Modal that matches screenshot styling ========= */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(8, 16, 36, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      visibility: hidden;
      opacity: 0;
      transition: opacity .18s, visibility .18s;
    }

    .overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .modal {
      width: 840px;
      max-width: 95%;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 30px 70px rgba(2, 6, 23, 0.6);
      background: linear-gradient(90deg, #0f3a72 0%, #08406b 60%);
    }

    /* left blue panel */
    .modal-left {
      flex: 0 0 320px;
      padding: 22px;
      color: #fff;
      background: linear-gradient(180deg, #0f3a72, #0a2f58);
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: relative;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand .avatar {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
    }

    .price-summary {
      background: rgba(255, 255, 255, 0.06);
      padding: 12px;
      border-radius: 10px;
      font-weight: 700;
    }

    .phone-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      border-radius: 10px;
      color: #d9e9ff;
      font-size: 14px;
    }

    .left-art {
      position: absolute;
      right: -40px;
      bottom: -22px;
      opacity: 0.85;
      width: 220px;
      filter: drop-shadow(0 20px 40px rgba(2, 8, 23, 0.45));
    }

    .secure-note {
      font-size: 12px;
      opacity: 0.9;
      margin-top: auto;
      color: rgba(255, 255, 255, 0.9);
    }

    /* right white card */
    .modal-right {
      flex: 1;
      background: #fff;
      padding: 20px 22px;
      color: #122;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 15px;
      color: #123;
    }

    .close-x {
      background: transparent;
      border: 0;
      font-size: 20px;
      color: #444;
      cursor: pointer;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .card-input {
      width: 100%;
      border: 1px solid #e6ecf5;
      padding: 12px 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .row-2 {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .col {
      flex: 1;
    }

    .save-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      color: #556;
    }

    .continue-btn {
      margin-top: 14px;
      background: linear-gradient(180deg, var(--bg-ui), var(--accent));
      color: #fff;
      border: 0;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      width: 180px;
    }

    /* confirmation popup (inside modal overlay) */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 260;
      visibility: hidden;
      opacity: 0;
      transition: opacity .12s, visibility .12s;
    }

    .confirm-overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .confirm-card {
      width: 520px;
      max-width: 94%;
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.28);
    }

    .confirm-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .confirm-body {
      font-size: 14px;
      color: #333;
      line-height: 1.4;
      margin-bottom: 14px;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-ghost {
      padding: 10px 14px;
      border-radius: 10px;
      background: #f2f4fb;
      border: 1px solid #e6eaf7;
      cursor: pointer;
    }

    .btn-primary {
      padding: 10px 14px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent), var(--bg-ui));
      color: #fff;
      border: 0;
      cursor: pointer;
    }

    /* small responsive */
    @media (max-width:720px) {
      .modal {
        flex-direction: column;
        width: 95%;
      }

      .modal-left {
        flex: 0 0 auto;
        padding: 14px;
        order: 2;
      }

      .modal-right {
        order: 1;
        padding: 16px;
      }

      .left-art {
        display: none;
      }

      .pay-option {
        width: 30%;
        min-width: 90px;
      }
    }

    /* small success toast */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: linear-gradient(90deg, var(--accent), var(--bg-ui));
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 14px 40px rgba(2, 6, 23, 0.4);
      z-index: 400;
      transform: translateY(8px);
      opacity: 0;
      transition: opacity .18s, transform .18s;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>

  <!-- UPDATED: blue navbar at top (back button transformed into visible navbar control) -->
  <header class="app-header top-back">
    <button class="back-btn" id="backBtn" aria-label="Back">‚Üê</button>
    <div class="title">Recharge</div>
    <div style="min-width:36px;"></div>
  </header>

  <div class="container">
    <div class="tabs-row" style="margin-top:14px;">
      <button class="tab-switch active" data-target="rechSection">Recharge</button>
      <button class="tab-switch" data-target="withSection">Withdraw</button>
    </div>

    <section id="rechSection" class="tab-content active">
      <div class="amount-box" aria-label="Amount options">
        <button class="amt-btn" data-value="480">480</button>
        <button class="amt-btn" data-value="1980">1980</button>
        <button class="amt-btn" data-value="4970">4970</button>
        <button class="amt-btn" data-value="13680">13680</button>
      </div>

      <div class="rech-card">
        <div class="balance-label">Balance: <span id="balanceDisplay">‚Çπ 0.00</span></div>
        <div class="input-box">
          <div class="rs">‚Çπ</div>
          <input id="amountInput" type="number" placeholder="Please enter the recharge amount" min="0"
            inputmode="numeric" />
        </div>
      </div>

      <!-- PAYMENT METHODS: rendered as icon tiles (image-like). no screenshot data used. -->
      <div class="rech-card" aria-label="Payment methods">
        <div class="pay-methods" role="list">
          <div class="pay-option active" data-method="upi" role="button" tabindex="0" aria-pressed="true">
            <div class="pay-icon" aria-hidden="true">U</div>
            <div class="pay-label">UPI</div>
          </div>

          <div class="pay-option" data-method="cards" role="button" tabindex="0" aria-pressed="false">
            <div class="pay-icon" aria-hidden="true">C</div>
            <div class="pay-label">Cards</div>
          </div>

          <div class="pay-option" data-method="netbanking" role="button" tabindex="0" aria-pressed="false">
            <div class="pay-icon" aria-hidden="true">N</div>
            <div class="pay-label">Netbanking</div>
          </div>

          <div class="pay-option" data-method="wallet" role="button" tabindex="0" aria-pressed="false">
            <div class="pay-icon" aria-hidden="true">W</div>
            <div class="pay-label">Wallet</div>
          </div>

          <div class="pay-option" data-method="paylater" role="button" tabindex="0" aria-pressed="false">
            <div class="pay-icon" aria-hidden="true">P</div>
            <div class="pay-label">Pay later</div>
          </div>
        </div>
      </div>

      <button id="payBtn" class="pay-btn">Pay 0</button>

      <div class="info-box">
        Invest 4970 rs and you can withdraw 1462 rs daily.<br>
        Invite one user to invest 4970 rs and you will receive a commission of 1242.5 rs.
      </div>

    </section>

    <section id="withSection" class="tab-content" style="display:none;">
      <div class="card" style="padding:18px;">
        <h3 style="margin-top:0;">Withdraw</h3>
        <p style="margin-top:6px;"><strong>Wallet Balance: ‚Çπ 0</strong></p>
        <input id="withAmount" type="number" placeholder="Enter withdrawal amount"
          style="width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc;" />
        <input id="withTarget" type="text" placeholder="Enter UPI ID or Bank Account"
          style="width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc;" />
        <button class="primary" style="width:100%;margin-top:16px;">
          Withdraw Now
        </button>
      </div>
    </section>
  </div>

  <!-- ====== Modal markup (matches screenshot: left dark-blue panel + right white form) ====== -->
  <div id="paymentOverlay" class="overlay" role="dialog" aria-hidden="true" aria-labelledby="payTitle">
    <div class="modal" role="document" aria-modal="true">
      <div class="modal-left" aria-hidden="false">
        <div class="brand">
          <div class="avatar">D</div>
          <div>
            <div style="font-weight:800;font-size:15px;">Demo Shop</div>
            <div style="font-size:12px;opacity:0.9;">Price Summary</div>
          </div>
        </div>

        <div class="price-summary" id="modalPrice">‚Çπ 0.00</div>

        <div class="phone-row">Using as +91 ‚Ä¢ <span id="modalPhone" style="margin-left:6px;">**********</span></div>

        <!-- artwork (use provided image if available) -->
        <img src="/mnt/data/WhatsApp Image 2025-11-17 at 17.20.54_770effb8.jpg" alt="" class="left-art" />

        <div class="secure-note">Secured by <strong>Razorpay</strong></div>
      </div>

      <div class="modal-right">
        <div class="modal-header">
          <h3 id="payTitle">Payment Options</h3>
          <button class="close-x" id="modalClose" aria-label="Close">‚úï</button>
        </div>

        <!-- dynamic payment form container -->
        <div id="paymentFormContainer" aria-live="polite">
          <!-- default content (will be replaced by JS) -->
          <div style="color:#556">Choose a payment method to see required fields here.</div>
        </div>

        <!-- bottom actions area (submit gets inserted by JS) -->
        <div id="modalActions" style="display:flex; justify-content:flex-end; margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Confirmation overlay -->
  <div id="confirmOverlay" class="confirm-overlay" aria-hidden="true">
    <div class="confirm-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="confirm-header">
        <div id="confirmTitle" style="font-weight:800">Confirm Payment</div>
        <div style="color:#666" id="confirmIcon">üîí</div>
      </div>
      <div class="confirm-body" id="confirmBody">
        <!-- filled by JS -->
      </div>
      <div class="confirm-actions">
        <button class="btn-ghost" id="confirmCancel">Cancel</button>
        <button class="btn-primary" id="confirmProceed">Confirm & Pay</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Payment successful</div>

  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="script.js"></script>

  <script>
    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      if (history.length > 1) history.back();
      else window.location.href = 'home.html';
    });

    // Tab switching
    const tabs = document.querySelectorAll('.tab-switch');
    const sections = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        sections.forEach(s => { s.style.display = 'none'; s.classList.remove('active'); });
        tab.classList.add('active');
        const target = document.getElementById(tab.dataset.target);
        if (target) { target.style.display = 'block'; target.classList.add('active'); }
      });
    });

    // Amount buttons
    const amtBtns = document.querySelectorAll('.amt-btn');
    const amountInput = document.getElementById('amountInput');
    const payBtn = document.getElementById('payBtn');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const withBalanceDisplay = document.querySelector('#withSection strong');

    function setSelectedAmount(val) {
      amountInput.value = val;
      updatePayLabel();
      amtBtns.forEach(b => b.classList.toggle('active', b.dataset.value === String(val)));
    }
    amtBtns.forEach(btn => {
      btn.addEventListener('click', () => setSelectedAmount(btn.dataset.value));
    });

    function updatePayLabel() {
      const val = Number(amountInput.value) || 0;
      payBtn.textContent = 'Recharge ‚Çπ ' + val;
    }
    amountInput.addEventListener('input', updatePayLabel);
    updatePayLabel();

    // Payment method selection
    const payOptions = Array.from(document.querySelectorAll('.pay-option'));
    let activeMethod = 'upi'; // default

    function setActiveMethod(methodEl) {
      payOptions.forEach(o => {
        o.classList.toggle('active', o === methodEl);
        o.setAttribute('aria-pressed', o === methodEl ? 'true' : 'false');
      });
      activeMethod = methodEl.dataset.method;
      if (document.getElementById('paymentOverlay').classList.contains('show')) renderPaymentForm(activeMethod);
    }

    payOptions.forEach(opt => {
      opt.addEventListener('click', () => setActiveMethod(opt));
    });

    // Modal logic
    const overlay = document.getElementById('paymentOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalPrice = document.getElementById('modalPrice');
    const modalPhone = document.getElementById('modalPhone');
    const modalActions = document.getElementById('modalActions');
    const formContainer = document.getElementById('paymentFormContainer');

    function openPaymentModal() {
      const amount = Number(amountInput.value) || 0;
      if (amount <= 0) { alert('Please enter a valid amount.'); amountInput.focus(); return; }

      modalPrice.textContent = '‚Çπ ' + amount.toFixed(2);
      // Phone will be updated by checkAuth/updateUI in script.js, or we can fetch it
      // For now, placeholder

      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
      renderPaymentForm(activeMethod);
    }
    function closePaymentModal() {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }

    modalClose.addEventListener('click', closePaymentModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closePaymentModal(); });
    payBtn.addEventListener('click', openPaymentModal);

    function renderPaymentForm(method) {
      modalActions.innerHTML = '';
      formContainer.innerHTML = '';

      // We only support Razorpay (UPI/Cards/Netbanking) via the backend flow
      // The UI shows separate options, but we'll route them all to Razorpay checkout
      // except "Pay Later" which is mock.

      if (method === 'paylater') {
        formContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#666">Pay Later is currently unavailable. Please use UPI or Cards.</div>';
        return;
      }

      // For UPI, Cards, Netbanking, Wallet (external) -> All go to Razorpay
      formContainer.innerHTML = `
        <div style="padding:10px 0; color:#333;">
          <p>You are about to add <strong>‚Çπ ${amountInput.value}</strong> to your wallet.</p>
          <p style="font-size:13px;color:#666;margin-top:6px;">Secure payment via Razorpay.</p>
        </div>
      `;

      const submit = document.createElement('button');
      submit.className = 'continue-btn';
      submit.textContent = 'Proceed to Pay';
      submit.onclick = initiateRecharge;
      modalActions.appendChild(submit);
    }

    // Backend Integration: Recharge
    async function initiateRecharge() {
      const amount = Number(amountInput.value);
      if (!amount) return;

      const btn = document.querySelector('.continue-btn');
      if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }

      try {
        const fetchFn = window.apiFetch || fetch;
        // 1. Create Order
        const res = await fetchFn('/api/purchases/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amount }) // sending amount triggers recharge flow
        });

        if (!res.ok) throw new Error('Order creation failed');
        const orderData = await res.json();

        // 2. Open Razorpay
        const options = {
          key: orderData.key,
          amount: orderData.amount,
          currency: "INR",
          name: "Red Bull",
          description: "Wallet Recharge",
          order_id: orderData.orderId,
          handler: async function (response) {
            // 3. Verify
            try {
              const verifyRes = await fetchFn('/api/purchases/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature
                })
              });
              const verifyData = await verifyRes.json();
              if (verifyData.verified) {
                closePaymentModal();
                showToast('Recharge Successful!');
                loadBalance(); // refresh balance
              } else {
                alert('Verification failed: ' + verifyData.message);
              }
            } catch (e) {
              console.error(e);
              alert('Payment verification error');
            }
          },
          theme: { color: "#0b3d91" }
        };

        const rzp1 = new Razorpay(options);
        rzp1.open();
        rzp1.on('payment.failed', function (response) {
          alert('Payment Failed: ' + response.error.description);
        });

        if (btn) { btn.disabled = false; btn.textContent = 'Proceed to Pay'; }

      } catch (e) {
        console.error(e);
        alert('Failed to initiate recharge. Please try again.');
        if (btn) { btn.disabled = false; btn.textContent = 'Proceed to Pay'; }
      }
    }

    // Backend Integration: Withdraw
    const withBtn = document.querySelector('#withSection button.primary');
    if (withBtn) {
      withBtn.addEventListener('click', async () => {
        const amount = document.getElementById('withAmount').value;
        const target = document.getElementById('withTarget').value; // UPI or Bank

        if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
        if (!target) { alert('Enter UPI ID or Bank Account'); return; }

        withBtn.disabled = true;
        withBtn.textContent = 'Requesting...';

        try {
          const fetchFn = window.apiFetch || fetch;
          const res = await fetchFn('/api/withdraws/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: Number(amount), method: 'upi', details: { upi: target } }) // defaulting method to upi for simplicity
          });

          const data = await res.json();
          if (res.ok) {
            alert('Withdrawal requested successfully!');
            document.getElementById('withAmount').value = '';
            document.getElementById('withTarget').value = '';
            loadBalance();
          } else {
            alert('Error: ' + (data.message || 'Failed'));
          }
        } catch (e) {
          console.error(e);
          alert('Network error');
        } finally {
          withBtn.disabled = false;
          withBtn.textContent = 'Withdraw Now';
        }
      });
    }

    // Load Balance
    async function loadBalance() {
      try {
        const fetchFn = window.apiFetch || fetch;
        const res = await fetchFn('/api/auth/me');
        if (res.ok) {
          const data = await res.json();
          if (data.user) {
            const bal = '‚Çπ ' + (data.user.wallet || 0).toFixed(2);
            balanceDisplay.textContent = bal;
            if (withBalanceDisplay) withBalanceDisplay.textContent = 'Wallet Balance: ' + bal;

            // Update modal phone if open
            if (modalPhone) modalPhone.textContent = data.user.phone;
          }
        }
      } catch (e) {
        console.error('Load balance error', e);
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadBalance();
      // Remove "Wallet" from pay options as it's not valid for recharge
      const walletOpt = document.querySelector('.pay-option[data-method="wallet"]');
      if (walletOpt) walletOpt.style.display = 'none';
    });

  </script>
</body>

</html>
</body>

</html>