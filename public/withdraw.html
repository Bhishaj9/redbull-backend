<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Withdraw - Redbull</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Page-local small tweaks (won't affect other pages) */
    .tabs-row {
      display: flex;
      gap: 10px;
      margin: 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }

    .tab-btn.inactive {
      background: #fff;
      color: #0b3b7a;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    }

    .tab-btn.active {
      background: #06326a;
      color: #fff;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      margin-bottom: 16px;
    }

    .field {
      background: #f7f7f7;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
    }

    .field input {
      border: 0;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 16px;
    }

    .label {
      margin: 8px 0 4px 0;
      color: #333;
      font-weight: 600;
    }

    .primary-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #06326a;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .ghost-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(6, 50, 106, 0.12);
      background: #fff;
      color: #06326a;
      font-weight: 700;
      cursor: pointer;
    }

    .small-note {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }

    footer.bottom-nav .nav-link {
      text-decoration: none;
      color: #06326a;
    }

    footer.bottom-nav .nav-link.active {
      color: #06326a;
    }

    /* page scroll / container sizing */
    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      padding-bottom: 80px;
      overflow-y: auto;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      width: 94%;
      max-width: 920px;
      margin: 12px auto;
      padding: 0 12px;
      box-sizing: border-box;
    }

    /* desktop/mobile spacing */
    @media(max-width:420px) {
      .card {
        padding: 14px;
      }

      .field input {
        font-size: 15px;
      }

      .tab-btn {
        padding: 12px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>

  <!-- App header + back button -->
  <header class="app-header" style="position:sticky;top:0;z-index:50; display:flex; align-items:center;">
    <button id="backBtn" aria-label="Back"
      style="background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:10px; margin-left:0;">
      ‚Üê
    </button>

    <div class="title">Withdraw</div>
  </header>

  <div class="container">

    <!-- Tabs -->
    <div class="tabs-row" role="tablist" aria-label="Recharge/Withdraw tabs">
      <button id="rchTab" class="tab-btn inactive" data-target="recharge.html" aria-selected="false">
        <span aria-hidden="true">üì•</span>&nbsp; Recharge
      </button>
      <button id="withTab" class="tab-btn active" aria-selected="true">
        <span aria-hidden="true">üí∏</span>&nbsp; Withdraw
      </button>
    </div>

    <!-- Withdraw card -->
    <div class="card" role="region" aria-label="Withdraw form" id="withdrawCard">
      <div class="label">Amount</div>
      <div class="field" aria-hidden="false">
        <div style="font-size:18px;">‚Çπ</div>
        <input id="amountInput" type="number" min="0" placeholder="Enter Amount" inputmode="numeric" />
      </div>

      <div class="small-note">Balance : <strong id="balanceText">‚Çπ 0.00</strong></div>

      <div class="label" style="margin-top:12px;">Withdrawal Password</div>
      <div class="field">
        <div style="font-size:18px;">üîí</div>
        <input id="withdrawPass" type="password" placeholder="Enter Withdrawal Password" />
      </div>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="withdrawBtn" class="primary-btn" aria-live="polite">Withdraw 0</button>
      </div>
    </div>

    <!-- Bank details card -->
    <div class="card" role="region" aria-label="Bank details" id="bankCard">
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <div class="label">Real Name</div>
          <input id="bankName" class="field" style="padding:10px;" placeholder="Enter your real name" />
        </div>

        <div>
          <div class="label">IFSC</div>
          <input id="bankIFSC" class="field" style="padding:10px;" placeholder="Enter IFSC" />
        </div>

        <div>
          <div class="label">Bank Account</div>
          <input id="bankAccount" class="field" style="padding:10px;" placeholder="Enter your bank account number" />
        </div>

        <div>
          <div class="label">Number</div>
          <input id="bankMobile" class="field" style="padding:10px;" placeholder="Enter mobile/number" />
        </div>

        <button id="bindBankBtn" class="ghost-btn"
          style="display:flex;align-items:center;justify-content:center;gap:8px;">
          <span>‚öô</span> Bind Bank Card
        </button>
      </div>
    </div>

    <!-- Submit button moved below bank details as requested -->
    <div style="width:94%; max-width:920px; margin:0 auto 30px; box-sizing:border-box;">
      <button id="submitBtn" class="primary-btn" style="display:block;">Submit</button>
    </div>

    <!-- History Section -->
    <div class="card" id="historyCard">
      <div class="label">Withdrawal History</div>
      <div id="historyList" style="margin-top:10px;">
        <div style="text-align:center;color:#666;font-size:13px;">Loading...</div>
      </div>
    </div>

  </div>

  <!-- Bottom nav -->
  <footer class="bottom-nav" role="navigation" aria-label="Bottom navigation">
    <a href="home.html" class="nav-link">Plan</a>
    <a href="share.html" class="nav-link">Share</a>
    <a href="team.html" class="nav-link">Team</a>
    <a href="profile.html" class="nav-link">My</a>
  </footer>

  <script src="script.js"></script>
  <script>
    /* ====== DOM refs ====== */
    const backBtn = document.getElementById('backBtn');
    const rchTab = document.getElementById('rchTab');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const submitBtn = document.getElementById('submitBtn');
    const bindBankBtn = document.getElementById('bindBankBtn');
    const amountInput = document.getElementById('amountInput');
    const withdrawPass = document.getElementById('withdrawPass');
    const balanceText = document.getElementById('balanceText');

    const bankName = document.getElementById('bankName');
    const bankIFSC = document.getElementById('bankIFSC');
    const bankAccount = document.getElementById('bankAccount');
    const bankMobile = document.getElementById('bankMobile');
    const historyList = document.getElementById('historyList');

    /* ====== Navigation ====== */
    backBtn.addEventListener('click', () => { if (history.length > 1) history.back(); else window.location.href = 'home.html'; });
    rchTab.addEventListener('click', () => window.location.href = 'recharge.html');
    bindBankBtn.addEventListener('click', () => saveBankDetails(true)); // just save

    /* ====== Load Data ====== */
    async function loadData() {
      try {
        const fetchFn = window.apiFetch || fetch;
        const res = await fetchFn('/api/auth/me');
        if (res.ok) {
          const data = await res.json();
          if (data.user) {
            balanceText.textContent = "‚Çπ " + (data.user.wallet || 0).toFixed(2);

            if (data.user.bankDetails) {
              bankName.value = data.user.bankDetails.name || ""; // Real Name
              bankIFSC.value = data.user.bankDetails.ifsc || "";
              bankAccount.value = data.user.bankDetails.account || "";
              // bankMobile not in schema, using phone or ignoring
              bankMobile.value = data.user.phone || "";
            }
          }
        }
        loadHistory();
      } catch (e) {
        console.error('Load data error', e);
      }
    }

    async function loadHistory() {
      try {
        const fetchFn = window.apiFetch || fetch;
        const res = await fetchFn('/api/withdraws/my');
        if (res.ok) {
          const data = await res.json();
          renderHistory(data.withdraws || []);
        }
      } catch (e) {
        console.error('Load history error', e);
        historyList.innerHTML = '<div style="text-align:center;color:red;font-size:13px;">Failed to load history</div>';
      }
    }

    function renderHistory(list) {
      if (list.length === 0) {
        historyList.innerHTML = '<div style="text-align:center;color:#999;font-size:13px;">No withdrawals yet</div>';
        return;
      }
      historyList.innerHTML = '';
      list.forEach(w => {
        const item = document.createElement('div');
        item.style.padding = '10px';
        item.style.borderBottom = '1px solid #eee';
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.fontSize = '14px';

        const statusColor = w.status === 'approved' ? 'green' : (w.status === 'rejected' ? 'red' : 'orange');

        item.innerHTML = `
          <div>
            <div style="font-weight:600;">‚Çπ ${w.amount}</div>
            <div style="font-size:12px;color:#666;">${new Date(w.createdAt).toLocaleDateString()}</div>
          </div>
          <div style="color:${statusColor};font-weight:600;text-transform:capitalize;">
            ${w.status}
          </div>
        `;
        historyList.appendChild(item);
      });
    }

    /* ====== Actions ====== */
    async function saveBankDetails(showMsg = false) {
      const name = bankName.value.trim();
      const code = bankIFSC.value.trim();
      const acc = bankAccount.value.trim();

      if (!name || !code || !acc) {
        alert('Please fill all bank details (Name, IFSC, Account)');
        return false;
      }

      try {
        const fetchFn = window.apiFetch || fetch;
        const res = await fetchFn('/api/auth/bank', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            ifsc: code,
            account: acc,
            bankName: 'Unknown' // Schema requires it, but UI doesn't have it. Sending placeholder.
          })
        });

        if (res.ok) {
          if (showMsg) alert('Bank details saved');
          return true;
        } else {
          const d = await res.json();
          alert('Error saving bank details: ' + d.message);
          return false;
        }
      } catch (e) {
        console.error(e);
        alert('Network error saving bank details');
        return false;
      }
    }

    async function handleWithdraw() {
      const amount = Number(amountInput.value);
      const pass = withdrawPass.value.trim();

      if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
      if (!pass) { alert('Enter withdrawal password'); return; }

      // Save bank details first (implicit)
      const bankSaved = await saveBankDetails();
      if (!bankSaved) return;

      if (!confirm(`Confirm withdrawal of ‚Çπ ${amount}?`)) return;

      try {
        const fetchFn = window.apiFetch || fetch;
        const res = await fetchFn('/api/withdraws/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, withdrawPass: pass })
        });

        const data = await res.json();
        if (res.ok) {
          alert('Withdrawal requested successfully!');
          amountInput.value = '';
          withdrawPass.value = '';
          loadData(); // refresh balance and history
        } else {
          alert('Withdrawal failed: ' + data.message);
        }
      } catch (e) {
        console.error(e);
        alert('Network error');
      }
    }

    withdrawBtn.addEventListener('click', handleWithdraw);
    submitBtn.addEventListener('click', handleWithdraw);

    /* ====== Init ====== */
    function updateWithdrawLabel() { const val = Number(amountInput.value) || 0; withdrawBtn.textContent = 'Withdraw ' + val; }
    amountInput.addEventListener('input', updateWithdrawLabel);

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      updateWithdrawLabel();
    });

  </script>
</body>

</html>